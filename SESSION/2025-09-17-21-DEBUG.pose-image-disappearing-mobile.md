# SESSION: Debug Pose Image Disappearing on Mobile
**Date:** 2025-09-17
**Time:** 21:47
**Duration:** ~4 hours
**Type:** DEBUG

## ğŸ¯ **Objective**
Fix pose thumbnail images disappearing in pose library BottomSheet after selecting a pose. Issue occurs on **mobile/Android Expo app** but works fine on **web**.

## ğŸ“Š **Problem Description**

### **Symptoms**
- âœ… **Web**: All pose thumbnails remain visible after selection
- âŒ **Mobile**: Only selected pose thumbnail visible, others disappear (show placeholders)
- âœ… **Data Flow**: Selected pose correctly appears in PhotoCard component
- âŒ **Thumbnail Grid**: Non-selected poses lose their images

### **Initial Console Analysis**
```javascript
// Before selection - All poses had require() numbers
LOG: [{"id": "pose_1", "imageUrl": 6, "imageUrlType": "number"}, ...]

// After selection - Same data structure maintained
LOG: [{"id": "pose_1", "imageUrl": 6, "imageUrlType": "number"}, ...]
```

Data integrity was preserved, but images still disappeared on mobile.

## ğŸ”§ **Solutions Attempted**

### **Attempt 1: Complex Type Handling & Debugging**
**Approach**: Enhanced PhotoCard/Thumbnail components to handle complex ImageUrl objects

**Changes Made**:
- Added `ImageUrl` interface for `{height, width, uri}` format
- Enhanced PhotoCard with dynamic image source resolution
- Added comprehensive debugging logs
- Implemented immutable data handling in Zustand store

**Result**: âŒ **Failed** - Images still disappeared on mobile despite working on web

### **Attempt 2: Image Mapping System**
**Approach**: Created mapping from Metro require() numbers to actual images

**Changes Made**:
- Created `shared/utils/imageMapping.ts` utility
- Mapped numbers (6, 7) back to actual require() statements
- Enhanced both PhotoCard and Thumbnail components

**Result**: âŒ **Failed** - Still didn't resolve mobile issue

### **Attempt 3: Clean Path-Based Implementation**
**Approach**: Complete revert + reimplementation using string paths

**Changes Made**:
1. **Reverted all previous changes** to clean state
2. **Updated mockData**: Changed from `require('@/assets/poses/From-top.jpg')` to `'@/assets/poses/From-top.jpg'`
3. **Created clean utility**: `shared/utils/imageResolver.ts`
4. **Updated components**: Both Thumbnail and PhotoCard use path resolver
5. **Preserved data flow**: Strings throughout, require() only at render time

**Result**: ğŸ” **Status Unknown** - Implementation complete, needs testing

## ğŸ’¡ **Root Cause Analysis**

### **Why Web Works But Mobile Doesn't**

1. **Metro Bundler Differences**:
   - Web and mobile handle `require()` statements differently
   - Numbers generated by Metro may not resolve consistently on mobile

2. **React Native Image Component**:
   - Mobile Image component more strict about image source format
   - Web more forgiving with different image source types

3. **Memory/Cache Issues**:
   - Mobile may have different caching behavior for images
   - Could be related to how React Native handles image references

4. **Platform-Specific Behavior**:
   - Expo Go vs production build differences
   - Android vs iOS image handling variations

### **Why All Solutions Failed**
The core issue appears to be **platform-specific image resolution** rather than data flow problems. All our solutions fixed data integrity but didn't address the underlying mobile image loading issue.

## ğŸ¯ **Current State**

### **Architecture**
```
mockData: '@/assets/poses/From-top.jpg' (string path)
    â†“
Zustand Store: '@/assets/poses/From-top.jpg' (preserved string)
    â†“
Component Render: require('@/assets/poses/From-top.jpg') (resolved at render)
```

### **Files Modified**
- `mockData/dream/poses.ts` - Changed to string paths
- `types/dream/pose.ts` - Simplified to string imageUrl
- `shared/utils/imageResolver.ts` - Created path-to-require utility
- `components/ui/Thumbnail/Thumbnail.tsx` - Uses resolver
- `components/ui/PhotoCard/PhotoCard.tsx` - Uses resolver
- `components/PAGE/index/components/Top/PhotoCardGrid.tsx` - Uses paths

## ğŸ”® **Next Steps & Recommendations**

### **Immediate Testing**
1. Test current path-based implementation on mobile
2. Monitor console logs for path resolution warnings
3. Verify all thumbnails remain visible after pose selection

### **If Issue Persists - Alternative Approaches**

#### **Option A: Pre-load Images**
```typescript
// Pre-load all pose images at app startup
const preloadImages = async () => {
  const imagePromises = mockPoses.map(pose =>
    Image.prefetch(resolveImagePath(pose.imageUrl))
  )
  await Promise.all(imagePromises)
}
```

#### **Option B: Direct Require Mapping**
```typescript
// Use direct mapping instead of path resolution
const POSE_IMAGES = {
  'pose_1': require('@/assets/poses/From-top.jpg'),
  'pose_2': require('@/assets/poses/dress.jpg'),
}
```

#### **Option C: Image Component Replacement**
```typescript
// Use expo-image instead of React Native Image
import { Image } from 'expo-image'
```

#### **Option D: Force Re-render**
```typescript
// Force thumbnail re-render after pose selection
const [refreshKey, setRefreshKey] = useState(0)
useEffect(() => {
  if (selectedPose) {
    setRefreshKey(prev => prev + 1)
  }
}, [selectedPose])
```

### **Investigation Areas**
1. **Platform-specific debugging** - Add mobile-only logs
2. **Image loading timing** - Check if images load asynchronously
3. **Memory pressure** - Monitor if mobile runs out of image memory
4. **Expo Go vs Build** - Test in production build vs Expo Go

## ğŸ“ **Lessons Learned**

1. **Web != Mobile**: Never assume web behavior translates to mobile
2. **Data Flow vs Rendering**: Fixing data integrity doesn't always fix rendering issues
3. **Platform-Specific Issues**: Some bugs require platform-specific solutions
4. **Metro Bundler Complexity**: Asset handling can be platform-dependent

## ğŸ” **Key Files for Future Reference**

- `shared/utils/imageResolver.ts` - Clean path-to-require utility
- `mockData/dream/poses.ts` - String path implementation
- `components/ui/Thumbnail/Thumbnail.tsx` - Image resolution at render
- Session logs for debugging approach patterns

---

**Status**: ğŸŸ¡ **Implementation Complete - Awaiting Mobile Testing**
**Next Session**: Test mobile behavior and implement platform-specific fix if needed